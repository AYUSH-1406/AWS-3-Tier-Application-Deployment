name: CI-CD to EKS (Stage Based, Secure)

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-south-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com

jobs:
  build-scan-approve-deploy:
    name: Build ‚Üí Scan ‚Üí Approve ‚Üí Deploy
    runs-on: ubuntu-latest

    # üîê Manual approval via GitHub Environment
    environment: production

    steps:
    # ---------------------------
    # STAGE 1: Checkout
    # ---------------------------
    - name: Checkout source code
      uses: actions/checkout@v4

    # ---------------------------
    # STAGE 2: AWS Authentication
    # ---------------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # ---------------------------
    # STAGE 3: Login to ECR
    # ---------------------------
    - name: Login to Amazon ECR
      run: |
        aws ecr get-login-password --region $AWS_REGION | \
        docker login --username AWS --password-stdin $ECR_REGISTRY

    # ---------------------------
    # STAGE 4: Build app-tier image
    # ---------------------------
    - name: Build app-tier image
      run: |
        docker build -t app-tier:latest ./application-code/app-tier

    # ---------------------------
    # STAGE 5: Push app-tier image
    # ---------------------------
    - name: Push app-tier image to ECR
      run: |
        docker tag app-tier:latest $ECR_REGISTRY/app-tier:latest
        docker push $ECR_REGISTRY/app-tier:latest

    # ---------------------------
    # STAGE 6: Build web-tier image
    # ---------------------------
    - name: Build web-tier image
      run: |
        docker build -t web-tier:latest ./application-code/web-tier

    # ---------------------------
    # STAGE 7: Push web-tier image
    # ---------------------------
    - name: Push web-tier image to ECR
      run: |
        docker tag web-tier:latest $ECR_REGISTRY/web-tier:latest
        docker push $ECR_REGISTRY/web-tier:latest

     # ---------------------------
    # STAGE 8: Trivy Security Scan (WORKING)
    # ---------------------------
    - name: Trivy scan app-tier image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.ECR_REGISTRY }}/app-tier:latest
        format: table
        severity: CRITICAL,HIGH
        exit-code: 1
        ignore-unfixed: true
        scanners: vuln 

    - name: Trivy scan web-tier image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.ECR_REGISTRY }}/web-tier:latest
        format: table
        severity: CRITICAL,HIGH
        exit-code: 1
        ignore-unfixed: true
        scanners: vuln 

    # ---------------------------
    # STAGE 9: Deploy to EKS
    # ---------------------------
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region $AWS_REGION \
          --name ${{ secrets.EKS_CLUSTER_NAME }}

    - name: Deploy with rolling update
      run: |
        kubectl rollout restart deployment app-tier -n three-tier
        kubectl rollout restart deployment web-tier -n three-tier

    - name: Verify rollout
      run: |
        kubectl rollout status deployment app-tier -n three-tier
        kubectl rollout status deployment web-tier -n three-tier
